<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Sessions - SkillSync</title>
    <link rel="stylesheet" href="assets/css/findsession.css">
    <script src="assets/js/api.js"></script>
</head>
<body>
    <!-- Navigation Header -->
    <header class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>SkillSync</h2>
            </div>
            <div class="nav-user">
                <div class="user-info">
                    <span class="user-name" id="userName">Loading...</span>
                    <span class="user-role" id="userRole">Loading...</span>
                </div>
                <div class="nav-actions">
                    <button class="btn-notifications">
                        <span class="notification-icon">üîî</span>
                        <span class="notification-badge">3</span>
                    </button>
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="dashboard.html" class="nav-link">
                            <span class="nav-icon">üìä</span>
                            <span class="nav-text">Overview</span>
                        </a>
                    </li>
                    <li class="nav-item" id="findTutorsNav">
                        <a href="findtutor.html" class="nav-link">
                            <span class="nav-icon">üîç</span>
                            <span class="nav-text">Find Tutors</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="findsession.html" class="nav-link">
                            <span class="nav-icon">üìÖ</span>
                            <span class="nav-text">My Sessions</span>
                        </a>
                    </li>
                    <li class="nav-item" id="tutorDashboardNav" style="display: none;">
                        <a href="tutor-dashboard.html" class="nav-link">
                            <span class="nav-icon">üë®‚Äçüè´</span>
                            <span class="nav-text">Tutor Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="profile.html" class="nav-link">
                            <span class="nav-icon">üë§</span>
                            <span class="nav-text">Profile</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 id="pageTitle">My Sessions</h1>
                <p id="pageSubtitle">Manage your tutoring sessions</p>
            </div>

            <!-- Session Tabs -->
            <div class="sessions-tabs" id="sessionsTabs">
                <button class="tab-btn active" onclick="showTab('pending')" id="pendingTab">
                    <span class="tab-icon">‚è≥</span>
                    <span class="tab-text">Pending (<span id="pendingCount">0</span>)</span>
                </button>
                <button class="tab-btn" onclick="showTab('upcoming')" id="upcomingTab">
                    <span class="tab-icon">üìÖ</span>
                    <span class="tab-text">Upcoming (<span id="upcomingCount">0</span>)</span>
                </button>
                <button class="tab-btn" onclick="showTab('completed')" id="completedTab">
                    <span class="tab-icon">‚úÖ</span>
                    <span class="tab-text">Completed (<span id="completedCount">0</span>)</span>
                </button>
                <button class="tab-btn" onclick="showTab('cancelled')" id="cancelledTab">
                    <span class="tab-icon">‚ùå</span>
                    <span class="tab-text">Cancelled (<span id="cancelledCount">0</span>)</span>
                </button>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading-container">
                <div class="loading-spinner"></div>
                <p>Loading your sessions...</p>
            </div>

            <!-- Pending Sessions -->
            <div id="pending-sessions" class="sessions-content active">
                <div class="sessions-header">
                    <h2 id="pendingHeader">Pending Requests</h2>
                    <div class="header-actions" id="pendingActions">
                        <button class="btn-book-new" onclick="window.location.href='findtutor.html'" id="bookNewBtn">
                            <span>‚ûï</span> Book New Session
                        </button>
                    </div>
                </div>
                <div class="sessions-list" id="pendingList">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>

            <!-- Upcoming Sessions -->
            <div id="upcoming-sessions" class="sessions-content">
                <div class="sessions-header">
                    <h2>Upcoming Sessions</h2>
                    <div class="header-actions">
                        <button class="btn-book-new" onclick="window.location.href='findtutor.html'" id="bookNewBtn2">
                            <span>‚ûï</span> Book New Session
                        </button>
                    </div>
                </div>
                <div class="sessions-list" id="upcomingList">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>

            <!-- Completed Sessions -->
            <div id="completed-sessions" class="sessions-content">
                <div class="sessions-header">
                    <h2>Completed Sessions</h2>
                </div>
                <div class="sessions-list" id="completedList">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>

            <!-- Cancelled Sessions -->
            <div id="cancelled-sessions" class="sessions-content">
                <div class="sessions-header">
                    <h2>Cancelled Sessions</h2>
                </div>
                <div class="sessions-list" id="cancelledList">
                    <!-- Dynamic content will be loaded here -->
                </div>
            </div>

            <!-- No Results Message -->
            <div id="noResults" class="no-results" style="display: none;">
                <div class="no-results-content">
                    <h3>No sessions found</h3>
                    <p id="noResultsText">You don't have any sessions yet.</p>
                    <button class="btn-book-new" onclick="window.location.href='findtutor.html'">
                        <span>‚ûï</span> Book Your First Session
                    </button>
                </div>
            </div>
        </main>
    </div>

    <style>
        /* Loading styles */
        .loading-container {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }

        .no-results h3 {
            margin-bottom: 15px;
            color: #333;
        }

        /* Session card styles for accept/reject buttons */
        .booking-actions {
            display: flex;
            gap: 12px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .btn-accept {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-accept:hover {
            background: #218838;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-reject:hover {
            background: #c82333;
        }

        .btn-cancel {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-cancel:hover {
            background: #e0a800;
        }

        .session-message {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            border-left: 4px solid #007bff;
        }

        .session-message strong {
            color: #333;
        }

        .tutor-perspective .btn-book-new {
            display: none;
        }
    </style>

    <script>
        // Global variables
        let currentUser = null;
        let allBookings = [];
        let currentTab = 'pending';

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            if (!auth.requireAuth()) {
                return;
            }

            await initializePage();
        });

        async function initializePage() {
            try {
                showLoadingState();

                // Load user info
                currentUser = api.getUser();
                if (currentUser) {
                    document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                    document.getElementById('userRole').textContent = currentUser.role === 'tutor' ? 'Tutor' : 'Learner';

                    // Update UI based on role
                    updateUIForRole();
                }

                // Load bookings
                await loadBookings();

            } catch (error) {
                console.error('Error initializing page:', error);
                showError('Failed to load sessions. Please refresh the page.');
            }
        }

        function updateUIForRole() {
            if (currentUser.role === 'tutor') {
                document.getElementById('pageTitle').textContent = 'My Teaching Sessions';
                document.getElementById('pageSubtitle').textContent = 'Manage your tutoring requests and sessions';
                document.getElementById('pendingHeader').textContent = 'Booking Requests';
                document.getElementById('noResultsText').textContent = 'No booking requests yet. Students will find you through the Find Tutors page.';

                // Hide "Book New Session" buttons for tutors
                document.querySelectorAll('.btn-book-new').forEach(btn => btn.style.display = 'none');

                // Show tutor navigation if exists
                const tutorNav = document.getElementById('tutorDashboardNav');
                if (tutorNav) {
                    tutorNav.style.display = 'block';
                }

                document.body.classList.add('tutor-perspective');
            } else {
                document.getElementById('pendingHeader').textContent = 'Pending Requests';
                document.getElementById('noResultsText').textContent = 'You haven\'t booked any sessions yet.';
            }
        }

        async function loadBookings() {
            try {
                const response = await api.getBookings();
                allBookings = response.data || [];

                // Group bookings by status
                const pending = allBookings.filter(b => b.status === 'pending');
                const upcoming = allBookings.filter(b => b.status === 'accepted');
                const completed = allBookings.filter(b => b.status === 'completed');
                const cancelled = allBookings.filter(b => b.status === 'cancelled' || b.status === 'rejected');

                // Update tab counts
                document.getElementById('pendingCount').textContent = pending.length;
                document.getElementById('upcomingCount').textContent = upcoming.length;
                document.getElementById('completedCount').textContent = completed.length;
                document.getElementById('cancelledCount').textContent = cancelled.length;

                // Display current tab
                displayBookings(currentTab);
                hideLoadingState();

            } catch (error) {
                console.error('Error loading bookings:', error);
                hideLoadingState();
                showError('Failed to load sessions. Please try again.');
            }
        }

        function displayBookings(status) {
            let bookings;
            let listId;

            switch (status) {
                case 'pending':
                    bookings = allBookings.filter(b => b.status === 'pending');
                    listId = 'pendingList';
                    break;
                case 'upcoming':
                    bookings = allBookings.filter(b => b.status === 'accepted');
                    listId = 'upcomingList';
                    break;
                case 'completed':
                    bookings = allBookings.filter(b => b.status === 'completed');
                    listId = 'completedList';
                    break;
                case 'cancelled':
                    bookings = allBookings.filter(b => b.status === 'cancelled' || b.status === 'rejected');
                    listId = 'cancelledList';
                    break;
                default:
                    bookings = [];
                    listId = 'pendingList';
            }

            const list = document.getElementById(listId);
            const noResults = document.getElementById('noResults');

            if (bookings.length === 0) {
                list.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            list.style.display = 'block';
            noResults.style.display = 'none';

            list.innerHTML = bookings.map(booking => createBookingCard(booking)).join('');
        }

        function createBookingCard(booking) {
            const isUserTutor = currentUser.role === 'tutor';
            const otherPerson = isUserTutor ? booking.learner : booking.tutor;
            const date = new Date(booking.date);
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const statusClass = booking.status === 'pending' ? 'status-pending' :
                              booking.status === 'accepted' ? 'status-confirmed' :
                              booking.status === 'completed' ? 'status-completed' :
                              'status-cancelled';

            const timeFromNow = getTimeFromNow(date);

            return `
                <div class="session-card ${booking.status}">
                    <div class="session-time-badge ${booking.status === 'cancelled' || booking.status === 'rejected' ? 'cancelled-badge' : ''}">${timeFromNow}</div>
                    <div class="session-main">
                        <div class="session-header">
                            <div class="session-subject">${formatSubject(booking.subject)}</div>
                            <div class="session-status ${statusClass}">${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}</div>
                        </div>
                        <h3>Session with ${otherPerson.firstName} ${otherPerson.lastName}</h3>
                        <div class="session-details">
                            <div class="detail-item">
                                <span class="icon">üìÖ</span>
                                <span>${formattedDate}</span>
                            </div>
                            <div class="detail-item">
                                <span class="icon">‚è∞</span>
                                <span>${booking.timeSlot} (${booking.duration} minutes)</span>
                            </div>
                            <div class="detail-item">
                                <span class="icon">üìç</span>
                                <span>${booking.location}</span>
                            </div>
                            <div class="detail-item">
                                <span class="icon">${isUserTutor ? 'üë®‚Äçüéì' : 'üë®‚Äçüè´'}</span>
                                <span>${otherPerson.firstName} ${otherPerson.lastName} - ${otherPerson.university}</span>
                            </div>
                        </div>
                        ${booking.message ? `
                            <div class="session-message">
                                <strong>Message:</strong> ${booking.message}
                            </div>
                        ` : ''}
                        ${createActionButtons(booking)}
                    </div>
                </div>
            `;
        }

        function createActionButtons(booking) {
            const isUserTutor = currentUser.role === 'tutor';

            if (booking.status === 'pending' && isUserTutor) {
                // Tutor can accept or reject pending bookings
                return `
                    <div class="booking-actions">
                        <button class="btn-accept" onclick="updateBookingStatus('${booking._id}', 'accepted')">
                            <span>‚úÖ</span> Accept
                        </button>
                        <button class="btn-reject" onclick="updateBookingStatus('${booking._id}', 'rejected')">
                            <span>‚ùå</span> Reject
                        </button>
                    </div>
                `;
            } else if (booking.status === 'accepted') {
                // Both can cancel, tutor can complete
                let buttons = `
                    <div class="session-actions">
                        <button class="btn-cancel" onclick="updateBookingStatus('${booking._id}', 'cancelled')">
                            <span>‚ùå</span> Cancel
                        </button>
                `;

                if (isUserTutor) {
                    buttons += `
                        <button class="btn-accept" onclick="updateBookingStatus('${booking._id}', 'completed')">
                            <span>‚úÖ</span> Mark Complete
                        </button>
                    `;
                }

                buttons += '</div>';
                return buttons;
            } else if (booking.status === 'pending' && !isUserTutor) {
                // Learner can cancel pending requests
                return `
                    <div class="session-actions">
                        <button class="btn-cancel" onclick="updateBookingStatus('${booking._id}', 'cancelled')">
                            <span>‚ùå</span> Cancel Request
                        </button>
                    </div>
                `;
            }

            return '';
        }

        async function updateBookingStatus(bookingId, status) {
            const confirmMessages = {
                'accepted': 'Accept this booking request?',
                'rejected': 'Reject this booking request?',
                'cancelled': 'Cancel this session?',
                'completed': 'Mark this session as completed?'
            };

            if (!confirm(confirmMessages[status])) {
                return;
            }

            try {
                const response = await api.updateBookingStatus(bookingId, status);

                if (response.success) {
                    showSuccess(`Session ${status} successfully!`);
                    await loadBookings(); // Reload to update the display
                } else {
                    throw new Error(response.message);
                }
            } catch (error) {
                console.error('Error updating booking status:', error);
                showError(error.message || 'Failed to update session status. Please try again.');
            }
        }

        function formatSubject(subject) {
            return subject.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getTimeFromNow(date) {
            const now = new Date();
            const diffDays = Math.ceil((date - now) / (1000 * 60 * 60 * 24));

            if (diffDays < 0) {
                return Math.abs(diffDays) === 1 ? 'Yesterday' : `${Math.abs(diffDays)} days ago`;
            } else if (diffDays === 0) {
                return 'Today';
            } else if (diffDays === 1) {
                return 'Tomorrow';
            } else if (diffDays <= 7) {
                return `In ${diffDays} days`;
            } else {
                return 'Next week';
            }
        }

        function showTab(tab) {
            currentTab = tab;

            // Remove active class from all tabs and content
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.sessions-content').forEach(content => content.classList.remove('active'));

            // Add active class to clicked tab and corresponding content
            document.getElementById(tab + 'Tab').classList.add('active');
            document.getElementById(tab + '-sessions').classList.add('active');

            // Display bookings for this tab
            displayBookings(tab);
        }

        function showLoadingState() {
            document.getElementById('loadingState').style.display = 'block';
            document.querySelectorAll('.sessions-content').forEach(content => content.style.display = 'none');
            document.getElementById('noResults').style.display = 'none';
        }

        function hideLoadingState() {
            document.getElementById('loadingState').style.display = 'none';
            document.querySelectorAll('.sessions-content').forEach(content => content.style.display = 'none');
            document.getElementById(currentTab + '-sessions').style.display = 'block';
        }

        function showError(message) {
            alert('‚ùå ' + message);
        }

        function showSuccess(message) {
            alert('‚úÖ ' + message);
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                await auth.logout();
            }
        }
    </script>
</body>
</html>
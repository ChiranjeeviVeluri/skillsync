<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Tutors - SkillSync</title>
    <link rel="stylesheet" href="assets/css/findtutor.css">
    <script src="assets/js/api.js"></script>
</head>
<body>
    <!-- Navigation Header -->
    <header class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>SkillSync</h2>
            </div>
            <div class="nav-user">
                <div class="user-info">
                    <span class="user-name" id="userName">Loading...</span>
                    <span class="user-role" id="userRole">Loading...</span>
                </div>
                <div class="nav-actions">
                    <button class="btn-notifications">
                        <span class="notification-icon">üîî</span>
                        <span class="notification-badge">3</span>
                    </button>
                    <button class="btn-logout" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="dashboard.html" class="nav-link">
                            <span class="nav-icon">üìä</span>
                            <span class="nav-text">Overview</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="findtutor.html" class="nav-link">
                            <span class="nav-icon">üîç</span>
                            <span class="nav-text">Find Tutors</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="findsession.html" class="nav-link">
                            <span class="nav-icon">üìÖ</span>
                            <span class="nav-text">My Sessions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="profile.html" class="nav-link">
                            <span class="nav-icon">üë§</span>
                            <span class="nav-text">Profile</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1>Find Tutors</h1>
                <p>Discover tutors who can help you excel in your subjects</p>
            </div>

            <!-- Search and Filters -->
            <div class="search-section">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Search by subject or tutor name...">
                    <button class="btn-search" onclick="searchTutors()">
                        <span>üîç</span> Search
                    </button>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label for="subjectFilter">Subject</label>
                        <select id="subjectFilter" onchange="filterTutors()">
                            <option value="">All Subjects</option>
                            <option value="mathematics">Mathematics</option>
                            <option value="physics">Physics</option>
                            <option value="chemistry">Chemistry</option>
                            <option value="computer-science">Computer Science</option>
                            <option value="english">English</option>
                            <option value="biology">Biology</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="availabilityFilter">Availability</label>
                        <select id="availabilityFilter" onchange="filterTutors()">
                            <option value="">Any Time</option>
                            <option value="available">Available Now</option>
                            <option value="morning">Morning</option>
                            <option value="afternoon">Afternoon</option>
                            <option value="evening">Evening</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="ratingFilter">Min Rating</label>
                        <select id="ratingFilter" onchange="filterTutors()">
                            <option value="">Any Rating</option>
                            <option value="4">4+ Stars</option>
                            <option value="4.5">4.5+ Stars</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sortFilter">Sort By</label>
                        <select id="sortFilter" onchange="sortTutors()">
                            <option value="rating">Highest Rating</option>
                            <option value="reviews">Most Reviews</option>
                            <option value="availability">Available Now</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Results Summary -->
            <div class="results-summary">
                <p><span id="resultCount">Loading...</span> tutors found</p>
                <button class="btn-clear-filters" onclick="clearFilters()">Clear Filters</button>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading-container">
                <div class="loading-spinner"></div>
                <p>Searching for tutors...</p>
            </div>

            <!-- Tutors Grid -->
            <div class="tutors-grid" id="tutorsGrid">
                <!-- Dynamic tutor cards will be populated here -->
            </div>

            <!-- No Results Message -->
            <div id="noResults" class="no-results" style="display: none;">
                <div class="no-results-content">
                    <h3>No tutors found</h3>
                    <p>Try adjusting your filters or search terms.</p>
                    <button class="btn-clear-filters" onclick="clearFilters()">Clear All Filters</button>
                </div>
            </div>

            <!-- Load More Button -->
            <div class="load-more-section">
                <button class="btn-load-more" onclick="loadMoreTutors()">Load More Tutors</button>
            </div>
        </main>
    </div>

    <!-- Booking Modal (will be styled later) -->
    <div id="bookingModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Book Session</h3>
            <p>Booking functionality will be connected to backend</p>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>

    <style>
        /* Additional styles for dynamic content */
        .loading-container {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: 80px 20px;
            color: #666;
        }

        .no-results h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .tutor-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        .availability-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .availability-badge.online {
            background: #d4edda;
            color: #155724;
        }

        .availability-badge.busy {
            background: #f8d7da;
            color: #721c24;
        }

        .subject-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 6px;
            margin-bottom: 4px;
            display: inline-block;
        }

        .stars {
            color: #ffc107;
            margin-right: 8px;
        }
    </style>

    <script>
        // Global variables
        let currentTutors = [];
        let currentUser = null;
        let currentPage = 1;
        let isLoading = false;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            if (!auth.requireAuth()) {
                return;
            }

            await initializePage();
        });

        async function initializePage() {
            try {
                // Load user info
                currentUser = api.getUser();
                if (currentUser) {
                    document.getElementById('userName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                    document.getElementById('userRole').textContent = currentUser.role === 'tutor' ? 'Tutor' : 'Learner';
                }

                // Load tutors
                await loadTutors();

                // Set up search debouncing
                let searchTimeout;
                document.getElementById('searchInput').addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        loadTutors();
                    }, 500);
                });

            } catch (error) {
                console.error('Error initializing page:', error);
                showError('Failed to load tutors. Please refresh the page.');
            }
        }

        async function loadTutors(resetPage = true) {
            if (isLoading) return;
            isLoading = true;

            if (resetPage) {
                currentPage = 1;
            }

            try {
                showLoadingState();

                // Get filter values
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: 20
                });

                const search = document.getElementById('searchInput').value.trim();
                const subject = document.getElementById('subjectFilter').value;
                const availability = document.getElementById('availabilityFilter').value;
                const minRating = document.getElementById('ratingFilter').value;
                const sortBy = document.getElementById('sortFilter').value;

                if (search) params.append('search', search);
                if (subject) params.append('subject', subject);
                if (availability) params.append('availability', availability);
                if (minRating) params.append('minRating', minRating);
                if (sortBy) params.append('sortBy', sortBy);

                const response = await fetch(`/api/tutors?${params}`);
                const data = await response.json();

                if (data.success) {
                    currentTutors = resetPage ? data.data : [...currentTutors, ...data.data];
                    displayTutors(currentTutors);
                    updateResultCount(data.count);

                    // Show/hide load more button
                    const loadMoreSection = document.querySelector('.load-more-section');
                    if (data.currentPage < data.totalPages) {
                        loadMoreSection.style.display = 'block';
                    } else {
                        loadMoreSection.style.display = 'none';
                    }
                } else {
                    throw new Error(data.message);
                }

                hideLoadingState();

            } catch (error) {
                console.error('Error loading tutors:', error);
                hideLoadingState();
                showError('Failed to load tutors. Please try again.');
            } finally {
                isLoading = false;
            }
        }

        function displayTutors(tutors) {
            const grid = document.getElementById('tutorsGrid');
            const noResults = document.getElementById('noResults');

            if (tutors.length === 0) {
                grid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            noResults.style.display = 'none';

            grid.innerHTML = tutors.map(tutor => createTutorCard(tutor)).join('');
        }

        function createTutorCard(tutor) {
            const initials = (tutor.firstName.charAt(0) + tutor.lastName.charAt(0)).toUpperCase();
            const stars = '‚≠ê'.repeat(Math.floor(tutor.stats.averageRating));
            const availabilityClass = tutor.stats.isAvailable ? 'online' : 'busy';

            return `
                <div class="tutor-card" data-tutor-id="${tutor._id}">
                    <div class="tutor-header">
                        <div class="tutor-avatar">${initials}</div>
                        <div class="availability-badge ${availabilityClass}">
                            ${tutor.stats.availabilityText}
                        </div>
                    </div>
                    <div class="tutor-info">
                        <h3>${tutor.firstName} ${tutor.lastName}</h3>
                        <p class="tutor-university">${tutor.university} - ${getYearText(tutor.year)}</p>
                        <div class="tutor-subjects">
                            ${tutor.subjects.map(subject =>
                                `<span class="subject-tag">${formatSubject(subject)}</span>`
                            ).join('')}
                        </div>
                        <div class="tutor-rating">
                            <div class="stars">${stars}</div>
                            <span class="rating-text">${tutor.stats.averageRating} (${tutor.stats.reviewCount} reviews)</span>
                        </div>
                        <p class="tutor-description">Expert in ${tutor.subjects.map(s => formatSubject(s)).join(', ')}. Available for personalized tutoring sessions.</p>
                        <div class="tutor-stats">
                            <span class="stat">üìö ${tutor.stats.totalSessions}+ sessions</span>
                            <span class="stat">üí∞ $${tutor.stats.hourlyRate}/hour</span>
                        </div>
                    </div>
                    <div class="tutor-actions">
                        <button class="btn-view-profile" onclick="viewProfile('${tutor._id}')">View Profile</button>
                        <button class="btn-book-session" onclick="bookSession('${tutor._id}')">
                            ${tutor.stats.isAvailable ? 'Book Session' : 'Schedule Later'}
                        </button>
                    </div>
                </div>
            `;
        }

        function formatSubject(subject) {
            return subject.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function getYearText(year) {
            const yearMap = {
                '1': '1st Year',
                '2': '2nd Year',
                '3': '3rd Year',
                '4': '4th Year',
                'graduate': 'Graduate Student'
            };
            return yearMap[year] || year;
        }

        function showLoadingState() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('tutorsGrid').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
        }

        function hideLoadingState() {
            document.getElementById('loadingState').style.display = 'none';
        }

        function updateResultCount(count) {
            document.getElementById('resultCount').textContent = count;
        }

        function showError(message) {
            alert(message); // Replace with a better error display later
        }

        // Event handlers
        function searchTutors() {
            loadTutors();
        }

        function filterTutors() {
            loadTutors();
        }

        function sortTutors() {
            loadTutors();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('subjectFilter').value = '';
            document.getElementById('availabilityFilter').value = '';
            document.getElementById('ratingFilter').value = '';
            document.getElementById('sortFilter').value = 'rating';
            loadTutors();
        }

        function viewProfile(tutorId) {
            // Navigate to tutor profile page (implement later)
            alert('Tutor profile page will be implemented in next stage.');
        }

        function bookSession(tutorId) {
            // Navigate to booking page (implement later)
            alert('Session booking will be implemented in next stage.');
        }

        function loadMoreTutors() {
            currentPage++;
            loadTutors(false);
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                await auth.logout();
            }
        }

        function closeModal() {
            document.getElementById('bookingModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('bookingModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>